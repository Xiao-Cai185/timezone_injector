name: Build Timezone Injector

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Create build directory
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        New-Item -ItemType Directory -Path build

    # ---- Build gui_injector.exe (Main GUI Application) ----
    - name: Build gui_injector.exe
      run: |
        cl /O2 /EHsc /W3 gui_injector.cpp /link /SUBSYSTEM:WINDOWS /out:build/gui_injector.exe user32.lib gdi32.lib kernel32.lib comdlg32.lib
      shell: cmd

    # ---- Build timezonehook.dll (Injection DLL) ----
    - name: Build timezonehook.dll
      run: |
        cl /LD /O2 /EHsc /W3 timezonehook.cpp /link /out:build/timezonehook.dll kernel32.lib
      shell: cmd

    # ---- Build injector.exe (Legacy CLI tool) ----
    - name: Build injector.exe
      run: |
        cl /O2 /EHsc /W3 injector.cpp /link /out:build/injector.exe kernel32.lib
      shell: cmd

    - name: List build artifacts
      run: |
        Write-Host "Build artifacts:"
        Get-ChildItem -Path build -Recurse | Format-Table Name, Length, LastWriteTime

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: timezone-injector-windows
        path: build/*
        retention-days: 90

    - name: Commit build artifacts to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add build/
        git diff --staged --quiet || git commit -m "Auto-build: Update binaries [skip ci]"
        git push
      continue-on-error: true
