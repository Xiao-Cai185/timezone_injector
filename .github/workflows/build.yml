name: Build Injectors + TimezoneHook

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-all:
    runs-on: windows-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Download Detours
      run: |
        curl -L -o detours.zip https://github.com/microsoft/Detours/archive/refs/heads/main.zip
        powershell -Command "Expand-Archive detours.zip -DestinationPath detours"
        move detours\Detours-main detours-src

    - name: Create build directory
      run: mkdir build

    # -------------------------------
    # Build timezonehook.dll
    # -------------------------------
    - name: Build timezonehook.dll
      run: |
        cl /LD /O2 /EHsc timezonehook.cpp ^
          /I detours-src\include ^
          detours-src\lib.X64\detours.lib ^
          /link /out:build/timezonehook.dll

    # -------------------------------
    # Build injector.exe
    # -------------------------------
    - name: Build injector.exe
      run: |
        cl /O2 /EHsc injector.cpp ^
          /I detours-src\include ^
          detours-src\lib.X64\detours.lib ^
          /link /out:build/injector.exe

    # -------------------------------
    # Build gui_injector.exe (Win GUI)
    # -------------------------------
    - name: Build gui_injector.exe
      run: |
        cl /O2 /EHsc gui_injector.cpp ^
          /DUNICODE /D_UNICODE ^
          /I detours-src\include ^
          detours-src\lib.X64\detours.lib ^
          /link /out:build/gui_injector.exe /SUBSYSTEM:WINDOWS

    # -------------------------------
    # Upload all artifacts
    # -------------------------------
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: timezone-injector-suite
        path: build/*
